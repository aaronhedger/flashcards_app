{% load static %}
<!DOCTYPE html>

<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{% static 'css/styles_existing_flashcards.css' %}">
    <link rel="stylesheet" href="{% static 'css/styles_existing_classeurs.css' %}">

    <title>Flashcards</title>

</head>
<body>
    <nav>
          <h1> App'Rouss√¥ </h1>
          <ul>
              <li><a href="{% url 'welcome' %}"> Page d'acceuil</a></li>
              <li><a href="{% url 'retour' %}"> Retour</a></li>
          </ul>
    </nav>
    <audio id="clickSound">
        <source src="{{ audio_file_path }}" type="audio/mpeg">
        Your browser does not support the audio element.
    </audio>

    <div class="container3">
        <h1>Voc Allemand 2</h1>
        <div class="flashcard" id="flashcard" onclick="flipCard()">
            <div class="flashcard-inner">
                <div class="flashcard-front">
                    <h2 id="flashcardTitle"></h2>
                    <p id="flashcardFrontContent"></p>
                </div>
                <div class="flashcard-back">
                    <h2 id="flashcardTitleBack"></h2>
                    <p id="flashcardBackContent"></p>
                </div>
            </div>
        </div>

        <div class="buttons">
            <button onclick="categorizeCard('a')">a</button>
            <button onclick="categorizeCard('b')">b</button>
            <button onclick="categorizeCard('c')">c</button>            
            <button onclick="categorizeCard('d')">d</button>

        </div>
        
    </div>
    

    <script>
    // Parse card data from Django context
    let cardData = {{ card_data|safe }};
    let currentCardIndex = 0;
    let categorizedCards = [];
    let currentRound = 1;
    const cardsPerRound = 9;

    function displayCard() {
        if (currentCardIndex >= cardData.length) {
            alert('All cards have been categorized!');
            return;
        }

        const card = cardData[currentCardIndex];
        document.getElementById('flashcardTitle').textContent = card.title;
        document.getElementById('flashcardFrontContent').innerHTML = card.front_content;
        document.getElementById('flashcardTitleBack').textContent = card.title;
        document.getElementById('flashcardBackContent').innerHTML = card.back_content;

        // Reset flip state
        const flashcard = document.getElementById('flashcard');
        flashcard.classList.remove('flipped');
    }

    function flipCard() {
        const flashcard = document.getElementById('flashcard');
        flashcard.classList.toggle('flipped');

        const clickSound = document.getElementById('clickSound');
        clickSound.play();
    }
    
    function categorizeCard(category) {
        const currentCard = cardData[currentCardIndex];
        categorizedCards.push({ card: currentCard, category: category });

        // Move to the next card
        currentCardIndex++;

        if (currentCardIndex % cardsPerRound === 0) {
            // After every 9 cards, process the next round
            processNextRound();
        } else {
            displayCard();
        }
    }

    function processNextRound() {
        // Update currentCardIndex based on categories
        let nextRoundCards = [];
        
        categorizedCards.forEach(({ card, category }) => {
            let roundsToWait = 0;
            switch (category) {
                case 'a':
                    roundsToWait = 1;
                    break;
                case 'b':
                    roundsToWait = 2;
                    break;
                case 'c':
                    roundsToWait = 3;
                    break;
                case 'd':
                    roundsToWait = 4;
                    break;
            }

            // Add card to next round based on rounds to wait
            const reappearIndex = (currentRound + roundsToWait - 1) * cardsPerRound;
            if (nextRoundCards[reappearIndex]) {
                nextRoundCards[reappearIndex].push(card);
            } else {
                nextRoundCards[reappearIndex] = [card];
            }
        });

        // Flatten the next round cards and set for display
        cardData = nextRoundCards.flat().filter(Boolean);
        currentCardIndex = 0; // Reset for the next round
        currentRound++; // Increment round
        displayCard(); // Show first card of the next round
    }

    // Initialize the first card
    displayCard();
</script>
</body>
</html>